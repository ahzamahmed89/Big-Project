document.addEventListener('DOMContentLoaded', function() {
  const generateButton = document.getElementById('generateFormButton');
  const branchCode = document.getElementById('branchCode');
  const branchName = document.getElementById('branchName');
  const regionName = document.getElementById('regionName');
  const monthSelect = document.getElementById('month');
  const quarterSelect = document.getElementById('quarter');
  const visitDateInput = document.getElementById('visitDate');
  const visitedBy = document.getElementById('visitedBy');
  const reviewedBy = document.getElementById('reviewedBy');
  const tableBody = document.getElementById('data-table').getElementsByTagName('tbody')[0];
  const currentDate = new Date();
  visitDateInput.valueAsDate = currentDate;

  function updateButtonState() {
    generateButton.disabled = !branchCode.value.trim() ||
      branchName.value.trim() === "Branch not found" ||
      !branchName.value.trim() ||
      !regionName.value.trim() ||
      !monthSelect.value.trim() ||
      !quarterSelect.value.trim() ||
      !visitDateInput.value.trim();
  }

  function initializeSelectors() {
    const currentDay = currentDate.getDate();
    const currentMonth = currentDate.getMonth();
    const currentYear = currentDate.getFullYear();
    const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

    monthSelect.innerHTML = '';
    months.forEach((month, index) => {
      const option = document.createElement('option');
      option.value = month;
      option.textContent = month;
      monthSelect.appendChild(option);
      if (index > currentMonth || (index < currentMonth - 1) || (index == currentMonth - 1 && currentDay >= 11)) {
        option.disabled = true;
      }
    });
    monthSelect.selectedIndex = currentMonth;

    quarterSelect.innerHTML = '';
    const quarters = ["Q1", "Q2", "Q3", "Q4"];
    quarters.forEach((quarter, index) => {
      const option = document.createElement('option');
      option.value = quarter;
      option.textContent = quarter;
      quarterSelect.appendChild(option);
      if (Math.floor(currentMonth / 3) != index) {
        option.disabled = true;
      }
    });
    quarterSelect.selectedIndex = Math.floor(currentMonth / 3);

    const minDate = new Date(currentYear, currentMonth, currentDay >= 11 ? 1 : 1);
    const maxDate = new Date(currentYear, currentMonth, currentDay);

    visitDateInput.min = minDate.toISOString().split('T')[0];
    visitDateInput.max = maxDate.toISOString().split('T')[0];
  }

  initializeSelectors();
  updateButtonState();

  generateButton.addEventListener('click', function(event) {
    event.preventDefault();
    const branchCodeValue = branchCode.value.trim();
    const year = new Date(visitDateInput.value).getFullYear();
    const month = monthSelect.value;
    const quarter = quarterSelect.value;

    if (!branchCodeValue) {
      alert("Branch code is required.");
      return;
    }

    if (branchName.value.trim() === "Branch not found") {
      alert("Invalid branch name.");
      return;
    }

    fetch(`http://localhost:5000/check-entry?branchCode=${branchCodeValue}&year=${year}&quarter=${quarter}&month=${month}`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert(data.message);
        } else {
          renderTableData(data.data);
          createSubmitButton();
        }
      })
      .catch(error => console.error('Error:', error));
  });

  branchCode.addEventListener('input', function() {
    const code = this.value.trim();
    if (code) {
      fetch(`http://localhost:5000/branch/${code}`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            branchName.value = data.data.Branch_Name;
            regionName.value = data.data.Region;
          } else {
            branchName.value = "Branch not found";
            regionName.value = "";
          }
          updateButtonState();
        })
        .catch(error => console.error('Error:', error));
    } else {
      branchName.value = "";
      regionName.value = "";
      updateButtonState();
    }
  });

  visitDateInput.addEventListener('input', function() {
    const selectedDate = new Date(this.value);
    if (selectedDate > currentDate) {
      alert("Future Date Cannot Be Selected, Please Select Current Date");
      this.value = "";
      return;
    }

    updateMonthSelector(selectedDate);
    updateButtonState();
  });

  function updateMonthSelector(selectedDate) {
    const selectedMonth = selectedDate.getMonth();
    const selectedDay = selectedDate.getDate();
    const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

    monthSelect.innerHTML = '';
    months.forEach((month, index) => {
      const option = document.createElement('option');
      option.value = month;
      option.textContent = month;
      monthSelect.appendChild(option);
      if (index > currentMonth || (index < currentMonth - 1) || (index == currentMonth - 1 && currentDay >= 11)) {
        option.disabled = true;
      }
      if (index == selectedMonth) {
        option.selected = true;
      }
    });
  }

  function renderTableData(fullData) {
    tableBody.innerHTML = '';

    fullData.forEach(item => {
      const row = tableBody.insertRow();
      row.dataset.code = item.Code;
      row.dataset.weightage = item.Weightage;

      const categoryCell = row.insertCell(0);
      const activityCell = row.insertCell(1);
      const statusCell = row.insertCell(2);
      const responsibilityCell = row.insertCell(3);
      const remarksCell = row.insertCell(4);
      const imageCell = row.insertCell(      5);

      categoryCell.textContent = item.Category;
      activityCell.textContent = item.Activity;

      const statusSelect = createStatusSelect();
      statusCell.appendChild(statusSelect);

      const responsibilitySelect = createResponsibilitySelect();
      responsibilityCell.appendChild(responsibilitySelect);

      const remarksInput = document.createElement('input');
      remarksInput.type = 'text';
      remarksCell.appendChild(remarksInput);

      const imageInput = document.createElement('input');
      imageInput.type = 'file';
      imageInput.accept = 'image/*';
      imageInput.capture = 'camera';
      imageCell.appendChild(imageInput);
    });
  }

  function createStatusSelect() {
    const statusSelect = document.createElement('select');
    ['Yes', 'No', 'NA'].forEach(status => {
      const option = document.createElement('option');
      option.value = status;
      option.textContent = status;
      statusSelect.appendChild(option);
    });

    statusSelect.addEventListener('change', function() {
      if (this.value === 'Yes') {
        this.style.color = 'darkgreen';
        this.style.fontWeight = 'bold';
      } else if (this.value === 'No') {
        this.style.color = 'darkred';
        this.style.fontWeight = 'bold';
      } else if (this.value === 'NA') {
        this.style.color = 'goldenrod';
        this.style.fontWeight = 'bold';
      }
    });

    statusSelect.dispatchEvent(new Event('change'));
    return statusSelect;
  }

  function createResponsibilitySelect() {
    const responsibilitySelect = document.createElement('select');
    responsibilitySelect.appendChild(document.createElement('option'));
    ['Admin', 'Branch Operations', 'IT', 'Marketing', 'Business', 'HR', 'Others'].forEach(resp => {
      const option = document.createElement('option');
      option.value = resp;
      option.textContent = resp;
      responsibilitySelect.appendChild(option);
    });
    return responsibilitySelect;
  }

  function createSubmitButton() {
    const submitButtonContainer = document.getElementById('submitButtonContainer');
    submitButtonContainer.innerHTML = '<button id="submitFormButton">Submit Form</button>';

    const submitFormButton = document.getElementById('submitFormButton');
    submitFormButton.addEventListener('click', function(event) {
      event.preventDefault();
      if (validateForm() && validateStatus()) {
        submitForm();
      }
    });
  }

  function validateForm() {
    let valid = true;
    let message = '';

    const requiredFields = [
      { field: branchCode, name: 'Branch Code' },
      { field: branchName, name: 'Branch Name' },
      { field: regionName, name: 'Region Name' },
      { field: quarterSelect, name: 'Quarter' },
      { field: monthSelect, name: 'Month' },
      { field: visitDateInput, name: 'Visit Date' },
      { field: visitedBy, name: 'Visited By' },
      { field: reviewedBy, name: 'Reviewed By OM/BM' }
    ];

    requiredFields.forEach(({ field, name }) => {
      if (!field.value.trim()) {
        valid = false;
        message += `${name} is required.\n`;
      }
    });

    if (!valid) {
      alert(message);
    }

    return valid;
  }

  function validateStatus() {
    let valid = true;
    let message = '';

    const tableRows = tableBody.getElementsByTagName('tr');
    for (let row of tableRows) {
      const status = row.cells[2].getElementsByTagName('select')[0].value;
      const responsibility = row.cells[3].getElementsByTagName('select')[0].value.trim();
      const remarks = row.cells[4].getElementsByTagName('input')[0].value.trim();
      const activity = row.cells[1].textContent;  // Get the activity detail

      if (status === 'No') {
        if (!responsibility) {
          valid = false;
          message += `Responsibility is required for activity "${activity}" with status "No".\n`;
        }
        if (!remarks) {
          valid = false;
          message += `Remarks are required for activity "${activity}" with status "No".\n`;
        }
      }
    }

    if (!valid) {
      alert(message);
    }

    return valid;
  }

  function submitForm() {
    const confirmedTime = prompt("Please confirm the visit time (HH:MM:SS AM/PM):", currentDate.toLocaleTimeString());
    const visitData = collectVisitData();

    const dataToSend = {
      Branch_Code: branchCode.value.trim(),
      Branch_Name: branchName.value.trim(),
      Region_Name: regionName.value.trim(),
      Quarter: quarterSelect.value.trim(),
      Month: monthSelect.value.trim(),
      Year: new Date(visitDateInput.value).getFullYear(),
      Visited_By: visitedBy.value.trim(),
      Visit_Date: visitDateInput.value.trim(),
      Visit_Time: confirmedTime,
      Reviewed_By_OM_BM: reviewedBy.value.trim(),
      Activities: visitData
    };

    fetch(`http://localhost:5000/submit-data`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(dataToSend)
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('Form submitted successfully!');
      } else {
        alert('Error submitting form: ' + data.message);
      }
    })
    .catch(error => console.error('Error:', error));
  }

  function collectVisitData() {
    const visitData = [];
    const tableRows = tableBody.getElementsByTagName('tr');

    for (let row of tableRows) {
      const code = row.dataset.code;
      const weightage = row.dataset.weightage;
      const category = row.cells[0].textContent;
      const activity = row.cells[1].textContent;
      const status = row.cells[2].getElementsByTagName('select')[0].value;
      const responsibility = row.cells[3].getElementsByTagName('select')[0].value.trim();
      const remarks = row.cells[4].getElementsByTagName('input')[0].value.trim();
      const imageInput = row.cells[5].getElementsByTagName('input')[0];

      const imageName = `${branchCode.value.trim()}${monthSelect.value}${new Date().getFullYear()}${code.padStart(3, '0')}`;
      const imagePath = `C:\\Users\\User\\Desktop\\Big Project\\Images\\${new Date().getFullYear()}\\${imageName}`;

      if (imageInput.files.length > 0) {
        const file = imageInput.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
          const arrayBuffer = e.target.result;
          saveImageToDisk(arrayBuffer, imagePath);
        };
        reader.readAsArrayBuffer(file);
      }

      visitData.push({
        Code: parseInt(code),
        Category: category,
        Activity: activity,
        Weightage: parseFloat(weightage),
        Status: status,
        Responsibility: responsibility,
        Remarks: remarks,
        Images: imagePath
      });
    }
    return visitData;
  }

  function saveImageToDisk(arrayBuffer, path) {
    // This function needs to be implemented server-side to save the image to disk
  }
});
=lorem()

